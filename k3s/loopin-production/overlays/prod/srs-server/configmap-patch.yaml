apiVersion: v1
kind: ConfigMap
metadata:
  name: srs-config
  namespace: loopin-production
data:
  srs.conf: |
    listen 1935;
    max_connections 1000;
    daemon off;
    srs_log_tank        console;
    srs_log_level       trace;

    http_api {
        enabled on;
        listen 1985;
    }

    http_server {
        enabled on;
        listen 8080;
        dir /usr/local/srs/objs/nginx/html;
    }

    vhost ingest.loopin.bid {
        hls {
            enabled on;
            hls_path /usr/local/srs/objs/nginx/html;
            hls_fragment 2;
            hls_window 12;

            hls_ctx on;
            hls_ts_ctx on;

            hls_m3u8_file [app]/[stream]/index.m3u8;
            hls_ts_file [app]/[stream]/[seq].ts;

            hls_acodec aac;
            hls_vcodec h264;
            hls_cleanup on;
            hls_dispose 30;
            hls_wait_keyframe off;
        }

        transcode live {
            enabled on;
            ffmpeg /usr/local/srs/objs/ffmpeg/bin/ffmpeg;

            engine 720p {
                enabled on;
                iformat flv;
                vcodec libx264; vbitrate 1750; vfps 60; vwidth 1280; vheight 720;
                vparams { g 240; sc_threshold 0; }
                vprofile main; vpreset ultrafast;
                acodec aac; abitrate 128; asample_rate 44100; achannels 2;
                oformat flv;
                output rtmp://127.0.0.1:[port]/abr/[app]?vhost=[vhost]/[stream]_720p;
            }

            engine 360p {
                enabled on;
                iformat flv;
                vcodec libx264; vbitrate 300; vfps 30; vwidth 640; vheight 360;
                vparams { g 60; sc_threshold 0; }
                vprofile main; vpreset ultrafast;
                acodec aac; abitrate 64; asample_rate 44100; achannels 2;
                oformat flv;
                output rtmp://127.0.0.1:[port]/abr/[app]?vhost=[vhost]/[stream]_360p;
            }
        }

        http_hooks {
            enabled on;
            on_publish http://streaming-service:80/api/v1/hooks/on_publish;
            on_unpublish http://streaming-service:80/api/v1/hooks/on_unpublish;
        }
    }
